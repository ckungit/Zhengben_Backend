<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhangben.backend.mapper.ActivityMemberMapper">

    <insert id="insert">
        INSERT INTO activity_member (activity_id, user_id, role)
        VALUES (#{activityId}, #{userId}, #{role})
    </insert>

    <select id="selectByActivityAndUser" resultType="map">
        SELECT m.*, u.nickname
        FROM activity_member m
        INNER JOIN user u ON m.user_id = u.id
        WHERE m.activity_id = #{activityId} AND m.user_id = #{userId}
    </select>

    <select id="selectByActivityId" resultType="map">
        SELECT m.user_id, u.nickname, u.avatar_url as avatarUrl, m.role, m.joined_at, u.primary_currency as primaryCurrency
        FROM activity_member m
        INNER JOIN user u ON m.user_id = u.id
        WHERE m.activity_id = #{activityId}
        ORDER BY m.joined_at
    </select>

    <delete id="delete">
        DELETE FROM activity_member WHERE activity_id = #{activityId} AND user_id = #{userId}
    </delete>

    <delete id="deleteByActivityId">
        DELETE FROM activity_member WHERE activity_id = #{activityId}
    </delete>

    <select id="countByActivityId" resultType="int">
        SELECT COUNT(*) FROM activity_member WHERE activity_id = #{activityId}
    </select>

    <!-- V51: Count outcomes related to a user in an activity -->
    <select id="countUserOutcomes" resultType="int">
        SELECT COUNT(DISTINCT o.id) FROM outcome o
        LEFT JOIN outcome_participant p ON o.id = p.outcome_id
        WHERE o.activity_id = #{activityId}
          AND o.deleted_flag = 0
          AND (o.payer_userid = #{userId} OR p.user_id = #{userId})
    </select>

    <!-- V40: GDPR - Delete all memberships for a user -->
    <delete id="deleteByUserId">
        DELETE FROM activity_member WHERE user_id = #{userId}
    </delete>

    <!-- V40: Get first other member for ownership transfer -->
    <select id="selectFirstOtherMember" resultType="map">
        SELECT m.user_id, u.nickname
        FROM activity_member m
        INNER JOIN user u ON m.user_id = u.id
        WHERE m.activity_id = #{activityId} AND m.user_id != #{excludeUserId}
        ORDER BY m.joined_at
        LIMIT 1
    </select>

</mapper>
